<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FSM HAR system: HAR system with FSM and ADC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FSM HAR system
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">HAR system with FSM and ADC </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Este proyecto implementa un sistema HAR con un sensor analógico de acelerometría ADXL335 para reconocimiento de actividad usando un modelo de <em>Machine Learning</em> kNN. El sistema utiliza el periférico ADC para muestrear los tres ejes XYZ del sensor, aunque también permite trabajar con datos de ejemplo guardados en memoria.</p>
<blockquote class="doxtable">
<p><b>Para utilizar los datos en memoria, se debe dejar descomentada</b> la línea <code>#define USE_ADC_STORED</code> en el archivo <code>adc_data_store.h</code>. </p>
</blockquote>
<p>La canfiguración del HW se muestra en la siguiente imagen: </p><div class="image">
<img src="fsm_har_bb.png" alt=""/>
<div class="caption">
HW HAR</div></div>
   <p>El sistema usa una FSM para gestionar los diferentes estados del sistema y el hardware. Esta imagen muestra la FSM del sistema:</p>
<div class="image">
<img src="fsm_har.png" alt=""/>
<div class="caption">
FSM HAR</div></div>
   <p>El sistema toma una medida de cada eje del acelerómetro cada vez que su temporizador es activado. La medida se realiza mediante el periférico ADC. El ADC está configurado para muestrear en modo único. El temporizador está configurado en el archivo <code>PORT</code> del sistema.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Define label </td><td class="markdownTableBodyNone">HAR_SYSTEM_TIMER  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Timer </td><td class="markdownTableBodyNone">TIM2  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Interrupt </td><td class="markdownTableBodyNone"><a class="el" href="interr_8c.html#a38ad4725462bdc5e86c4ead4f04b9fc2" title="Interrupt service routine for the TIM2 timer.">TIM2_IRQHandler()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Time interval </td><td class="markdownTableBodyNone">SAMPLING_PERIOD_ACCEL seconds  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Priority </td><td class="markdownTableBodyNone">2  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Subpriority </td><td class="markdownTableBodyNone">0  </td></tr>
</table>
<p>Puedes acceder al código fuente de este proyecto en el siguiente enlace: <a href="https://github.com/ieinDieUpm/fsm_har">HAR system with FSM and ADC</a>.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Implementación HW</h1>
<h1><a class="anchor" id="autotoc_md4"></a>
Sensor de acelerometría</h1>
<p>El sensor de acelerometría utilizado en el sistema es el ADXL335 (ver <a href="https://www.analog.com/media/en/technical-documentation/data-sheets/ADXL335.pdf">datasheet ADXL335</a>). El sensor está conectado a tres pines del microcontrolador. El sensor está configurado como una entrada analógica sin resistencia de pull-up ni pull-down. El sensor se muestrea en modo único con un periodo de muestreo dado por las interrupciones de un temporizador. Todas las configuraciones del ADC son por defecto. El ADC está configurado para interrumpir cuando la conversión se completa. El ADC está configurado con los siguientes ajustes:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">har_sensor.x  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin X </td><td class="markdownTableBodyNone">PA0 (A0 on Nucleo)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ADC Z </td><td class="markdownTableBodyNone">ADC1  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Channel X </td><td class="markdownTableBodyNone">0  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode X </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down X </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ISR </td><td class="markdownTableBodyNone"><a class="el" href="interr_8c.html#a06406eadf297fa89a6eaf9586b227a69" title="Interrupt service routine for all the ADCs.">ADC_IRQHandler()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Priority </td><td class="markdownTableBodyNone">1  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Subpriority </td><td class="markdownTableBodyNone">0  </td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">har_sensor.y  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin Y </td><td class="markdownTableBodyNone">PA1 (A1 on Nucleo)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ADC Y </td><td class="markdownTableBodyNone">ADC1  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Channel Y </td><td class="markdownTableBodyNone">1  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode Y </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down Y </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ISR </td><td class="markdownTableBodyNone"><a class="el" href="interr_8c.html#a06406eadf297fa89a6eaf9586b227a69" title="Interrupt service routine for all the ADCs.">ADC_IRQHandler()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Priority </td><td class="markdownTableBodyNone">1  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Subpriority </td><td class="markdownTableBodyNone">0  </td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter </th><th class="markdownTableHeadNone">Value  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Variable name </td><td class="markdownTableBodyNone">har_sensor.z  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pin Z </td><td class="markdownTableBodyNone">PA4 (A2 on Nucleo)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ADC Z </td><td class="markdownTableBodyNone">ADC1  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Channel Z </td><td class="markdownTableBodyNone">4  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mode Z </td><td class="markdownTableBodyNone">Analog  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pull up/ down Z </td><td class="markdownTableBodyNone">No push no pull  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ISR </td><td class="markdownTableBodyNone"><a class="el" href="interr_8c.html#a06406eadf297fa89a6eaf9586b227a69" title="Interrupt service routine for all the ADCs.">ADC_IRQHandler()</a>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Priority </td><td class="markdownTableBodyNone">1  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Subpriority </td><td class="markdownTableBodyNone">0  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md5"></a>
Funcionamiento detallado del sistema</h1>
<p>El sistema está codificado según el diagrama de estados mostrado anteriormente. El sistema se comporta de la siguiente manera:</p>
<ul>
<li>El sistema se inicia en el estado <code>GET_DATA</code>. En este estado espera a que el temporizador active la interrupción, active el ADC y muestree los datos del acelerómetro. Si se están usando los datos simulados, se obtienen los datos de la memoria (arrays <code>ADC_STORED_ACC_X</code>, <code>ADC_STORED_ACC_Y</code> y <code>ADC_STORED_ACC_Z</code>). En la ISR del temporizador se activa el <em>flag</em> <code>samples_available</code> del <code>har_sensor</code> para indicar que los datos están listos para ser almacenados.</li>
<li>Los datos se almacenan en el estado <code>GET_DATA</code>, en la función <code><a class="el" href="fsm__har__system_8c.html#a8374b901eccab8dd49dbfbec8af58aa1" title="Store the data from the accelerometer sensor.">do_store_data()</a></code>, en el array <code>acc_block</code> de la estructura de la FSM.</li>
<li>Cuando se han almacenado <code>WINDOW_SIZE_SAMPLES</code> datos, se activa el <em>flag</em> <code>acc_block_available</code> de la FSM y se cambia al estado <code>COMPUTE_FEATURES</code>.</li>
<li>En el estado <code>COMPUTE_FEATURES</code>, se calculan las características de los datos almacenados en <code>acc_block</code> y se almacenan en <code>features</code> de la FSM. Se calculan las características de: media, varianza, desviación estándar, valor máximo, valor mínimo, amplitud y mediana. Cuando se han calculado todas las características, se activa el <em>flag</em> <code>features_available</code>, se limpia el <em>flag</em> <code>acc_block_available</code> y se cambiará al estado <code>COMPUTE_ACTIVITY_RECOGNITION</code>.</li>
<li>En el estado <code>COMPUTE_ACTIVITY_RECOGNITION</code>, se ha inferido la actividad del usuario a partir de las características calculadas en el estado anterior con la función de salida <code><a class="el" href="fsm__har__system_8c.html#a617636deaca0cba5fb8062fb8733e79a" title="Compute the activity recognition.">do_compute_activity()</a></code>. Se calcula la distancia euclidiana entre las características (<em>features</em>) calculadas y los centroides del modelo almacenado. Se almacena el índice de la actividad inferida en el array de históricos <code>activities_detected</code> de la FSM. Por último, guarda en la variable <code>last_activity_name</code> el nombre de la actividad inferida. Cuando se ha inferido la actividad, se limpia el <em>flag</em> <code>features_computed</code> y se vuelve al estado inicial <code>GET_DATA</code>.</li>
<li>En esta última transición a <code>GET_DATA</code>, se llama a la función de salida <code><a class="el" href="fsm__har__system_8c.html#a3d4ce0528a8d396a267bad88a75cda92" title="Put the system to sleep.">do_sleep()</a></code>, que pone el sistema en modo de bajo consumo. Dormirá hasta que se active la interrupción del temporizador, cogerá el dato, y volverá a dormir. El sistema se mantiene despierto durante el cálculo de las características y la inferencia de la actividad.</li>
</ul>
<p>Se proporcionan trazas de depuración en la consola para mostrar el estado actual del sistema y las actividades inferidas.</p>
<p>Vaya al <a class="el" href="md_ejercicio.html">ejercicio</a> para realizar los cambios necesarios para que funcione correctamente.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
References</h1>
<ul>
<li><b>[1]</b>: <a href="https://moodle.upm.es/titulaciones/oficiales/course/view.php?id=785#section-0">Documentation available in the Moodle of the course</a></li>
<li><b>[2]</b>: <a href="https://web.eece.maine.edu/~zhu/book/index.php">Embedded Systems with ARM Cortex-M Microcontrollers in Assembly Language and C (Fourth Edition)</a> for explanations and examples of use of the ARM Cortex-M microcontrollers in C with CMSIS.</li>
<li><b>[3]</b>: <a href="https://ingenio.upm.es/primo-explore/fulldisplay?docid=34UPM_ALMA51126621660004212&amp;context=L&amp;vid=34UPM_VU1&amp;lang=es_ES&amp;search_scope=TAB1_SCOPE1&amp;adaptor=Local%20Search%20Engine&amp;tab=tab1&amp;query=any,contains,Programming%20with%20STM32:%20Getting%20Started%20with%20the%20Nucleo%20Board%20and%20C%2FC%2B%2B&amp;offset=0">Programming with STM32: Getting Started with the Nucleo Board and C/C++</a> for examples of use of the STM32 microcontrollers with the HAL of ST.</li>
<li><b>[4]</b>: <a href="https://ingenio.upm.es/primo-explore/fulldisplay?docid=34UPM_ALMA2151866130004212&amp;context=L&amp;vid=34UPM_VU1&amp;lang=es_ES&amp;search_scope=TAB1_SCOPE1&amp;adaptor=Local%20Search%20Engine&amp;isFrbr=true&amp;tab=tab1&amp;query=any,contains,C%20Programming%20Language">The C Programming Language</a></li>
<li><b>[5]</b>: <a href="https://www.elektor.com/products/nucleo-boards-programming-with-the-stm32cubeide">Nucleo Boards Programming with th STM32CubeIDE</a> for examples of use of the STM32 microcontrollers with the STM32CubeIDE. </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
